<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­åº«å­˜å®‰å…¨ç³»çµ± - v7.0</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #e74c3c; --warning: #f39c12; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f7f6; margin: 0; padding: 0; }
        nav { background: var(--primary); color: white; display: flex; justify-content: center; padding: 15px; gap: 8px; position: sticky; top: 0; z-index: 100; flex-wrap: wrap; }
        nav button { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 10px 15px; cursor: pointer; border-radius: 5px; }
        nav button.active { background: var(--accent); border-color: var(--accent); font-weight: bold; }
        .container { max-width: 1100px; margin: 20px auto; padding: 20px; }
        .page { display: none; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .page.active { display: block; }
        .sync-status { text-align: center; font-size: 12px; padding: 5px; background: #eee; color: #666; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; flex: 1; min-width: 150px; }
        button.btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; }
        .btn-add { background: var(--success); }
        .btn-action { background: var(--accent); }
        .btn-del { background: var(--danger); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; }
        .reason-tag { color: #888; font-style: italic; font-size: 0.85rem; }
        .diff-pos { color: var(--success); font-weight: bold; }
        .diff-neg { color: var(--danger); font-weight: bold; }
        /* é–å®šé®ç½© */
        #authOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
    </style>
</head>
<body>

<div id="authOverlay">
    <h2>è«‹è¼¸å…¥ç³»çµ±é‡‘é‘°ä»¥å­˜å–</h2>
    <input type="password" id="sysKeyInput" style="flex:none; width: 200px; margin-bottom: 15px;" placeholder="è¼¸å…¥é‡‘é‘°...">
    <button class="btn btn-action" onclick="initSystem()">è§£é–ç³»çµ±</button>
</div>

<div class="sync-status" id="syncLabel">é›²ç«¯ç‹€æ…‹ï¼šç­‰å¾…è§£é–</div>

<nav>
    <button onclick="showPage('p1')" id="btn-p1" class="active">ğŸ“¦ å»ºæª”</button>
    <button onclick="showPage('p2')" id="btn-p2">ğŸ“Š ç¸½è¡¨</button>
    <button onclick="showPage('p3')" id="btn-p3">ğŸ“¤ å¤–å€Ÿ/æ­¸é‚„</button>
    <button onclick="showPage('p4')" id="btn-p4">ğŸ” ç›¤é»ä¿®æ­£</button>
    <button onclick="showPage('p5')" id="btn-p5">ğŸ“œ æ­·å²ç´€éŒ„</button>
</nav>

<div class="container">
    <div id="p1" class="page active">
        <h2>å•†å“å»ºæª”ç®¡ç†</h2>
        <div class="input-group">
            <input type="text" id="pName" placeholder="åç¨±">
            <input type="number" id="pQty" placeholder="æ•¸é‡">
            <input type="text" id="pNote" placeholder="å‚™è¨»">
            <button class="btn btn-add" onclick="addProduct()">ç¢ºèªæ–°å¢</button>
        </div>
        <table id="setupTable"><thead><tr><th>åç¨±</th><th>ç¸½åº«å­˜</th><th>å‚™è¨»</th><th>ç®¡ç†</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="p2" class="page">
        <h2>åº«å­˜ç¸½è¡¨</h2>
        <input type="text" id="searchInput" class="search-bar" placeholder="ğŸ” æœå°‹..." onkeyup="renderAll()">
        <table id="fullTable"><thead><tr><th>åç¨±</th><th>ç¸½æ•¸/å¯ç”¨</th><th>ç‹€æ…‹</th><th>å‚™è¨»</th><th>æœ€å¾Œç›¤é»</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="p3" class="page">
        <h2>å¤–å€Ÿç®¡ç†</h2>
        <div class="input-group"><select id="loanProductSelect"></select><input type="text" id="loanUser" placeholder="å€Ÿç”¨äºº"><button class="btn btn-action" onclick="createLoan()">åŸ·è¡Œ</button></div>
        <table id="loanTable"><thead><tr><th>å€Ÿç”¨äºº</th><th>ç‰©å“</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="p4" class="page">
        <h2>å¹´åº¦ç›¤é»</h2>
        <table id="stocktakeTable"><thead><tr><th>åç¨±</th><th>å¸³é¢æ•¸</th><th>ä¸Šæ¬¡ç›¤é»</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="p5" class="page">
        <h2>ç›¤é»æ­·å²ç´€éŒ„ (å«ä¿®æ­£äº‹ç”±)</h2>
        <table id="historyTable"><thead><tr><th>è®Šå‹•æ™‚é–“</th><th>å“é …</th><th>è®Šå‹•</th><th>åŸå› /äº‹ç”±</th></tr></thead><tbody></tbody></table>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwei6lRay6e5RXLHPefnEHsOBLJ1KN7PuD203V4OiBWrmD_kAIWUoy4whlClkGb9wdh1w/exec"; 
    let sysKey = "";
    let products = [], loans = [], history = [];

    function initSystem() {
        sysKey = document.getElementById('sysKeyInput').value;
        if(!sysKey) return alert("è«‹è¼¸å…¥é‡‘é‘°");
        document.getElementById('authOverlay').style.display = 'none';
        syncFromCloud();
    }

    async function syncFromCloud() {
        document.getElementById('syncLabel').innerText = "é›²ç«¯ç‹€æ…‹ï¼šåŒæ­¥ä¸­...";
        try {
            const response = await fetch(`${API_URL}?key=${sysKey}`);
            const data = await response.json();
            if (data.error) {
                alert("é‡‘é‘°éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
                location.reload();
            } else {
                products = data.products || [];
                loans = data.loans || [];
                history = data.history || [];
                renderAll();
                document.getElementById('syncLabel').innerText = "é›²ç«¯ç‹€æ…‹ï¼šå·²åŒæ­¥";
            }
        } catch (e) {
            document.getElementById('syncLabel').innerText = "é›²ç«¯ç‹€æ…‹ï¼šé€£ç·šå¤±æ•—";
        }
    }

   async function save() {
    document.getElementById('syncLabel').innerText = "é›²ç«¯ç‹€æ…‹ï¼šæ­£åœ¨å„²å­˜...";
    const payload = {
        key: sysKey,
        data: { 
            products: products, 
            loans: loans, 
            history: history 
        }
    };

    try {
        await fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(payload)
        });
        document.getElementById('syncLabel').innerText = "é›²ç«¯ç‹€æ…‹ï¼šå„²å­˜æˆåŠŸ";
        // æœ¬åœ°åŒæ­¥æ›´æ–°ä¸€ä»½ï¼Œé˜²æ­¢æ–·ç¶²
        localStorage.setItem('cloud_inv_full_backup', JSON.stringify(payload.data));
    } catch (e) {
        document.getElementById('syncLabel').innerText = "é›²ç«¯ç‹€æ…‹ï¼šå„²å­˜å¤±æ•—";
    }
    renderAll();
}

    // ç›¤é»ä¿®æ­£ (æ–°å¢äº‹ç”±åŠŸèƒ½)
    function adjust(id) {
        const newVal = prompt("è«‹è¼¸å…¥å¯¦ç›¤ç¸½æ•¸é‡ï¼š");
        if(newVal !== null && newVal !== "") {
            const reason = prompt("è«‹è¼¸å…¥ä¿®æ­£äº‹ç”± (ä¾‹å¦‚ï¼šæå£ã€æ¼ç™»ã€å¹´åº¦ç›¤é»)ï¼š") || "æœªè¨»æ˜äº‹ç”±";
            const product = products.find(p => p.id == id);
            const oldQty = product.total;
            const newQty = parseInt(newVal);
            const diff = newQty - oldQty;
            const now = new Date().toLocaleString();

            history.unshift({ time: now, name: product.name, old: oldQty, new: newQty, diff: diff, reason: reason });
            product.total = newQty;
            product.available = newQty; 
            product.lastDate = now.split(' ')[0];
            save();
        }
    }

    // å…¶é¤˜åŸæœ¬çš„ addProduct, createLoan, returnItem, renderAll å‡½æ•¸ä¿æŒä¸è®Š...
    // (å› å­—æ•¸é™åˆ¶ï¼Œè«‹æ²¿ç”¨ v6.0 çš„æ¸²æŸ“é‚è¼¯ï¼Œä½†åœ¨æ¸²æŸ“æ­·å²ç´€éŒ„æ™‚åŠ å…¥ h.reason)
    
  function renderAll() {
    // 1. æ¸²æŸ“å»ºæª”é é¢è¡¨æ ¼ (æ–°å¢å¾Œæœƒç«‹åˆ»é¡¯ç¤ºåœ¨é€™è£¡)
    const setupBody = document.querySelector("#setupTable tbody");
    if (setupBody) {
        setupBody.innerHTML = products.map(p => `
            <tr>
                <td>${p.name}</td>
                <td>${p.total}</td>
                <td>${p.note || ''}</td>
                <td><button class="btn btn-del" onclick="deleteProduct(${p.id})">åˆªé™¤</button></td>
            </tr>
        `).join('');
    }

    // 2. æ¸²æŸ“ç¸½è¡¨
    const fullBody = document.querySelector("#fullTable tbody");
    if (fullBody) {
        fullBody.innerHTML = products.map(p => `
            <tr>
                <td>${p.name}</td>
                <td>${p.total} / ${p.available}</td>
                <td>${p.available > 0 ? 'âœ… æœ‰åº«å­˜' : 'âŒ å·²å€Ÿå…‰'}</td>
                <td>${p.note || ''}</td>
                <td>${p.lastDate || '---'}</td>
            </tr>
        `).join('');
    }

    // 3. æ¸²æŸ“ç›¤é»é é¢
    const stockBody = document.querySelector("#stocktakeTable tbody");
    if (stockBody) {
        stockBody.innerHTML = products.map(p => `
            <tr>
                <td>${p.name}</td>
                <td>${p.total}</td>
                <td>${p.lastDate || '---'}</td>
                <td><button class="btn btn-action" onclick="adjust(${p.id})">ä¿®æ­£æ•¸é‡</button></td>
            </tr>
        `).join('');
    }

    // 4. æ¸²æŸ“æ­·å²ç´€éŒ„ (åŠ ä¸Šäº‹ç”±)
    const historyBody = document.querySelector("#historyTable tbody");
    if (historyBody) {
        historyBody.innerHTML = history.map(h => `
            <tr>
                <td style="font-size:0.8rem">${h.time}</td>
                <td>${h.name}</td>
                <td class="${h.diff > 0 ? 'diff-pos' : 'diff-neg'}">${h.old} â†’ ${h.new} (${h.diff > 0 ? '+' + h.diff : h.diff})</td>
                <td class="reason-tag">${h.reason || 'ç„¡'}</td>
            </tr>
        `).join('');
    }

    // 5. æ›´æ–°å¤–å€Ÿä¸‹æ‹‰é¸å–®
    const select = document.getElementById('loanProductSelect');
    if (select) {
        select.innerHTML = products.map(p => `<option value="${p.id}">${p.name} (å‰©é¤˜:${p.available})</option>`).join('');
    }
}

// è£œä¸Šåˆªé™¤åŠŸèƒ½ï¼Œå¦å‰‡ renderAll æœƒå› ç‚ºæ‰¾ä¸åˆ° deleteProduct è€Œå ±éŒ¯
function deleteProduct(id) {
    if (confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å“é …å—ï¼Ÿç›¸é—œç´€éŒ„å°‡ä¸€ä½µç§»é™¤ã€‚")) {
        products = products.filter(p => p.id !== id);
        save();
    }
}
    // (è«‹è£œä¸Š v6.0 çš„åŸºç¤åŠŸèƒ½å‡½æ•¸)
    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('btn-' + id).classList.add('active');
        renderAll();
    }
    function addProduct() {
    const name = document.getElementById('pName').value;
    const qty = parseInt(document.getElementById('pQty').value);
    const note = document.getElementById('pNote').value;
    
    if(!name || isNaN(qty)) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");

    const newProduct = { 
        id: Date.now(), 
        name: name, 
        total: qty, 
        available: qty, 
        note: note, 
        lastDate: '---' 
    };

    products.push(newProduct);
    save(); // å‘¼å«å­˜æª”
    
    // æ¸…ç©ºè¼¸å…¥æ¡†
    document.getElementById('pName').value = ''; 
    document.getElementById('pQty').value = ''; 
    document.getElementById('pNote').value = '';
}
    function createLoan() {
        const pid = document.getElementById('loanProductSelect').value;
        const user = document.getElementById('loanUser').value;
        const product = products.find(p => p.id == pid);
        if(product && product.available > 0 && user) {
            product.available--;
            loans.push({ id: Date.now(), pid: product.id, pname: product.name, user });
            save();
            document.getElementById('loanUser').value = '';
        }
    }
    function returnItem(lid) {
        const loan = loans.find(l => l.id == lid);
        const product = products.find(p => p.id == loan.pid);
        if(product) product.available++;
        loans = loans.filter(l => l.id !== lid);
        save();
    }
</script>
</body>
</html>


